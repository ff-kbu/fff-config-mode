<% if not self.embedded then %>
<form method="post" enctype="multipart/form-data" action="<%=REQUEST_URI%>" onsubmit="return Orly();">
  <div>
    <script type="text/javascript" src="<%=resource%>/cbi.js"></script>
    <input type="hidden" name="cbi.submit" value="1" />
  </div>
<% end %>
  <div class="cbi-map" id="cbi-<%=self.config%>">
    <% if self.title and #self.title > 0 then %><h2><a id="content" name="content"><%=self.title%></a></h2><% end %>
    <% if self.description and #self.description > 0 then %><div class="cbi-map-descr"><%=self.description%></div><% end %>
    <% self:render_children() %>
    <br />
  </div>
<%- if self.message then %>
  <div><%=self.message%></div>
<%- end %>
<%- if self.errmessage then %>
  <div class="error"><%=self.errmessage%></div>
<%- end %>
<% if not self.embedded then %>
  <div>
<%-
  if type(self.hidden) == "table" then
    for k, v in pairs(self.hidden) do
-%>
  <input type="hidden" id="<%=k%>" name="<%=k%>" value="<%=pcdata(v)%>" />
<%-
    end
  end
%>
  <div class="actions">
  
  <script type="text/javascript">
	var passwordInput1 = document.getElementById("cbid.password.1.pw1");
	var passwordInput2 = document.getElementById("cbid.password.1.pw2");
    var reason1;
    var reason2;
    
    var midred = "#FF3A00";
    var yellow = "#E68A2E";
	var green = "#009900"; 
	
    var passwordOK = false;

    if(passwordInput1 == null || passwordInput2 == null){
        passwordOK = true;
    }else{    
        //Erstelle labels fuer Passwortinformationen        
        reason1 = document.getElementById("reason1");
        
        if(reason1 === null){
            var div = document.createElement("label");
            var id = document.createAttribute("id");
            id.value="reason1";
            div.setAttributeNode(id);
            
            document.getElementById("cbi-password-1-pw1").lastChild.appendChild(div);
            reason1 = document.getElementById("reason1");			
        }
	
        reason2 = document.getElementById("reason2");
	
        if(reason2 === null){
            var div = document.createElement("label");
            var id = document.createAttribute("id");
            id.value="reason2";
            div.setAttributeNode(id);
            
            document.getElementById("cbi-password-1-pw2").lastChild.appendChild(div);
            reason2 = document.getElementById("reason2");			
        }
        
        //ueberpruefe alle 250ms auf Passwortaenderungen
        window.setInterval("check()", 250); 
    }
		        
	function check() {
        passwordOK = true;
            
		if(passwordInput1.value.length == 0){
       		reason1.innerHTML = "";
       		passwordOK = false;
		}else{
			strength = new PasswordStrength();
			strength.password = passwordInput1.value;
		                
       		if(! strength.test_length()){
       		    reason1.style.color = midred;
       		    passwordOK = false;
       		}else if(! strength.test_components()){
       		    reason1.style.color = yellow;
       		    passwordOK = false;
       		}else{
       		    reason1.style.color = green;
       		}
       	
       		reason1.innerHTML = strength.status;
		}
		passwordsEqual();
	}
		
	function passwordsEqual(){
		if (passwordInput2.value.length == 0) {
			passwordInput2.style.background = "";
			reason2.innerHTML = "";
               		return false;
		} else if (passwordInput1.value === passwordInput2.value) {
			reason2.innerHTML = "Die Passwörter stimmen überein.";
               		reason2.style.color = green;
               		return true;
		} else {
			reason2.innerHTML = "Die Passwörter stimmen nicht überein.";
			reason2.style.color = midred;
               		return false;
		}
	}
        
    function Orly(){
        if(!passwordOK){
            if(! confirm("Das gewälte Passwort entspricht nicht den Anforderungen.\nTrotzdem Absenden?") ){
                return false;
            }
        }
        if(!equal()){
            alert("Es wurde kein Passwort gesetzt, oder die Passwörter stimmen nicht überein.");
            return false;
        }
        return true;
    }
        
    var PasswordStrength = function() {
        var UPPERCASE_LOWERCASE_RE = /([a-z].*[A-Z])|([A-Z].*[a-z])/;
        var SYMBOL_RE = /[!@#\$%^&*?\._\-+\*~=\/\\\(\){}\[\]<>:,;\"§\|]/;

        var min_password_length = 10

        this.status = null
        this.password = null

        this.test_length = function() {
            if(this.password.length < min_password_length){
                this.status = "Das Passwort sollte mindestens 10 Zeichen haben.";
                return false;
            }
            return true;
        };

        this.test_components = function() {
            if(!this.password.match(/[0-9]/)){
                this.status = "Es sollte mindestens eine Zahl im Passwort vorkommen.";
                return false;
            }
    
            if(!this.password.match(UPPERCASE_LOWERCASE_RE)){
                this.status = "Bitte verwende große und kleine Buchstaben";
                return false;
            }
    
            if(!this.password.match(SYMBOL_RE)){
                this.status = "Bitte verwende mindestens ein Sonderzeichen";
                return false;
            }
    
            this.status = "Das Passwort ist Akzeptabel."
            return true;
        };
    };
       
	</script>
<% if redirect then %>
  <div style="float:left">
    <input class="cbi-button cbi-button-link" type="button" value="<%:Back to Overview%>" onclick="location.href='<%=pcdata(redirect)%>'" />
  </div>
<% end %>
<%- if self.flow and self.flow.skip then %>
  <input class="cbi-button cbi-button-skip" type="submit" name="cbi.skip" value="<%:Skip%>" />
<% end %>
<%- if self.submit ~= false then %>
  <input class="cbi-button cbi-button-save btn primary" type="submit" value="
    <%- if not self.submit then -%>Weiter<%-else-%><%=self.submit%><%end-%>
  " />
<% end %>
<%- if self.reset ~= false then %>
  <input class="cbi-button cbi-button-reset" type="reset" value="
    <%- if not self.reset then -%><%-:Reset-%><%-else-%><%=self.reset%><%end-%>
  " />
<% end %>
<%- if self.cancel ~= false and self.on_cancel then %>
  <input class="cbi-button cbi-button-reset" type="submit" name="cbi.cancel" value="
    <%- if not self.cancel then -%><%-:Cancel-%><%-else-%><%=self.cancel%><%end-%>
  " />
<% end %>
<%
        local nav = require "luci.tools.freifunk-wizard.nav"
        local predecessor, successor = nav.get()
%>
  <% if predecessor then %>
    <a class="btn" href="<%=luci.dispatcher.build_url("wizard", predecessor.href)%>">
      Zurück
    </a>
  <% end %>
    <script type="text/javascript">cbi_d_update();</script>
  </div>
</form>
<% end %>
